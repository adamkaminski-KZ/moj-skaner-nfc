<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Skaner Kodów</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; padding: 10px; background-color: #f4f4f4; color: #333; }
      #container { max-width: 600px; margin: 0 auto; padding: 15px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      #reader { width: 100%; border: 2px solid #eee; border-radius: 8px; margin: 10px auto; }
      #status { margin-top: 15px; font-weight: bold; text-align: center; padding: 10px; border-radius: 5px; }
      button { font-size: 1em; padding: 12px; width: 100%; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
      button:disabled { background-color: #ccc; }
    </style>
  </head>
  <body>
    <div id="container">
      <h2>Skaner Kodów Kreskowych (Test 5)</h2>
      <div id="reader"></div>
      <button id="restartButton" style="display: none;">Skanuj ponownie</button>
      <div id="status">Pobieranie biblioteki skanera...</div>
    </div>

    <script 
      src="https://cdn.jsdelivr.net/npm/html5-qrcode@latest/dist/html5-qrcode.min.js" 
      onload="initializeApp()">
    </script>

    <script>
      // Wklej tutaj swój ADRES URL APLIKACJI INTERNETOWEJ
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwmEzbBhz9Gnivx00GQwDeoX6cDzLSh2SGagimqYYg8BUPbiuqUsHJmoZRLnef8oG2HiA/exec";

      // Zmienne globalne
      const statusDiv = document.getElementById('status');
      const restartButton = document.getElementById('restartButton');
      let html5QrcodeScanner;

      /**
       * Ta funkcja jest wywoływana przez 'onload' z tagu <script> powyżej
       */
      function initializeApp() {
        pokazStatus("Gotowy. Uruchamiam skaner...");
        
        try {
          html5QrcodeScanner = new Html5Qrcode("reader");
          startScanner(); // Uruchom skaner od razu

          restartButton.addEventListener('click', () => {
            startScanner(); // Uruchom ponownie po kliknięciu
          });
            
        } catch (e) {
          pokazStatus(`Błąd krytyczny: ${e.message}.`, true);
          console.error(e);
        }
      }

      // 
      // Reszta funkcji pomocniczych
      // 

      function onScanSuccess(decodedText, decodedResult) {
        pokazStatus(`Odczytano: ${decodedText}. Zapisywanie...`);
        html5QrcodeScanner.stop().catch(err => console.warn(err));
        wyslijDaneDoGoogle(decodedText);
      }

      async function wyslijDaneDoGoogle(dane) {
        try {
          const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ "dane": dane }),
            headers: { 'Content-Type': 'application/json' },
            mode: 'cors'
          });
          const result = await response.json();
          if (result.status === 'sukces') {
            pokazStatus("OK: Zapisano " + result.zapisano);
          } else {
            pokazStatus("Błąd serwera: " + result.wiadomosc, true);
          }
        } catch (error) {
          pokazStatus("Błąd sieci: " + error.message, true);
        } finally {
          restartButton.style.display = 'block';
        }
      }
      
      function pokazStatus(wiadomosc, czyBlad = false) {
        statusDiv.innerText = wiadomosc;
        statusDiv.style.color = czyBlad ? 'red' : 'black';
        statusDiv.style.backgroundColor = czyBlad ? '#f8d7da' : '#e9ecef';
      }

      function startScanner() {
        pokazStatus("Uruchamianie kamery...");
        restartButton.style.display = 'none';

        html5QrcodeScanner.start(
          { facingMode: "environment" }, // Tylna kamera
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          onScanSuccess,
          (errorMessage) => { /* ignorujemy błędy skanowania */ }
        ).catch((err) => {
          let errorName = (typeof err === 'string') ? err : (err.name || "UnknownError");
          pokazStatus(`BŁĄD: ${errorName}. Sprawdź uprawnienia.`, true);
          console.error("Błąd startu kamery:", err);
        });
      }
    </script>
  </body>
</html>
